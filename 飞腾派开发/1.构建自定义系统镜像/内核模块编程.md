# 内核模块编程

> 内核模块编程，就是编写内核C源代码生成自定义.ko文件:
>
> 参考： [2.1-理论-Linux驱动基础.pdf](.assets/2.1-理论-Linux驱动基础.pdf) 

下面以编写一个hello模块为例：



## 交叉编译生成`hello.ko`文件

- 保证交叉工具链与编译内核时的交叉工具链一致：

  这里使用[ARM官方网站](https://developer.arm.com/downloads/-/gnu-a/10-2-2020-11)下的`aarch64_be-none-linux-gnu`编译工具链：![image-20240122162316630](./%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E7%BC%96%E7%A8%8B.assets/image-20240122162316630.png)

  交叉编译工具链的配置参考： [交叉编译环境的构建.md](交叉编译环境的构建.md) 

  此编译链需要在`.bashrc`以及`.profile`中配置如下：

  ```bash
  export PATH=/opt/toolchains/gcc-arm-10.2-2020.11-x86_64-aarch64-none-linux-gnu/bin:$PATH
  export ARCH=arm64 CROSS_COMPILE=aarch64-none-linux-gnu-
  export CC=aarch64-none-linux-gnu-gcc
  ```

- 内核模块的编写与Makefile的编写

  参考 [2.1-理论-Linux驱动基础.pdf](.assets/2.1-理论-Linux驱动基础.pdf) **第三章：《Linux 内核模块编程》**

  以下给出内核模块以及Makefile的内容：

  - 内核模块：

    ```c
    #include <linux/init.h>
    #include <linux/module.h>
    static int test_init(void)
    {
    printk("hello world\n");
    return 0;
    }
    static void test_exit(void)
    {
    printk("bye\n");
    }
    module_init(test_init);
    module_exit(test_exit);
    MODULE_LICENSE("GPL");
    ```

  - Makefile：

    - `obj-m`参数：`obj-m := file.o` 表示编译连接后将生成file.ko 模块
    
    - `KDIR`参数：是内核Kbuild Makefile 所在路径。
    
      Linux 系统使用Kbuild Makefile 来编译内核或模块。
    
    - `all`参数、`clean`参数：
    
      - -C 指定内核Kbuild Makefile 所在路径。
      - M=指定模块所在路径。
    
    ```makefile
    obj-m := hello.o
    
    KDIR := /home/zrz/Project/phytium-pi-os/output/build/linux-custom
    
    all:
    	make -C $(KDIR) M=$(PWD) modules CROSS_COMPILE=aarch64-none-linux-gnu- ARCH=arm64
    
    clean:
    	make -C $(KDIR) M=$(PWD) clean
    ```

- 测试生成的`hello.ko`文件：

  - 在使用此内核生成的OS内加载模块：

    ```shell
    sudo insmod test.ko
    ```

    ![image-20240122224108576](./%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E7%BC%96%E7%A8%8B.assets/image-20240122224108576.png)

  - 查看内核日志：
  
    ```shell
    dmesg
    ```

    ![image-20240122224235397](./%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E7%BC%96%E7%A8%8B.assets/image-20240122224235397.png)

  - 卸载模块：
  
    ```shell
    sudo rmmod hello
    ```
  
    ![image-20240122224321515](./%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E7%BC%96%E7%A8%8B.assets/image-20240122224321515.png)
  
  