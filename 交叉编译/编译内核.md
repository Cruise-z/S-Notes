# 编译内核

## 1. 替换内核方法

### 配置和编译Rt 内核：

#### 下载源码包：

```bash
zrz@Zhao:~/Project/phytium_kernel$ git clone git@gitee.com:phytium_embedded/phytium-linux-kernel.git
```

#### 自定义内核

- 拷贝一份原系统中：

  - `/proc`目录下`config.gz`文件，解压得到==`config`==文件
  -  `/usr/src`目录下的<u>`linux-headers-xxx-embeded`</u>文件夹

- 修改配置：

  - 进入源码文件夹：

    ```bash
    zrz@Zhao:~/Project/phytium_kernel$ cd phytium-linux-kernel/
    ```

  - 先生成一份萤火工场飞腾派的`defconfig`配置：

    ```bash
    zrz@Zhao:~/Project/phytium_kernel/phytium-linux-kernel$ make phytiumpi_firefly_defconfig
    ```

  - 修改生成的**`.config`**文件(就位于源码文件夹目录下)

    按照原系统中解压得到的==`config`==文件内容，替换生成的**`.config`**文件中除**编译环境**外的所有内容：

    如下图：左边是==`config`==文件内容，右边是位于源码文件夹目录下的**`.config`**文件内容![image-20240112215704018](./%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8.assets/image-20240112215704018.png)这些地方的差异不用改变，因为自己的编译是在交叉编译环境中执行的。

  - 在<u>`linux-headers-xxx-embeded`</u>**文件夹**、**源码目录文件夹**执行`make menuconfig`命令：

    按照<u>`linux-headers-xxx-embeded`</u>**文件夹**下的menuconfig逐一配置**源码目录文件夹**下自定义内核的配置

    ```bash
    zrz@Zhao:~/Project/phytium_kernel/phytium-linux-kernel$ make menuconfig
    ```

  - 自定义配置中额外配置`Device Drivers`下的`gpio，pwm，i2c, spi`模块内的飞腾开发板支持![image-20240110011459990](./%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8.assets/image-20240110011459990.png)


#### 编译：

##### `-j12`使用12线程加速

```bash
zrz@Zhao:~/Project/phytium_kernel/phytium-linux-kernel$ make -j12
```



### 生成ko 的安装目录和文件：

由于内核很多模块编译成ko，所以需要手工生成ko的安装目录和文件：

```bash
zrz@Zhao:~/Project/phytium_kernel/phytium-linux-kernel$ mkdir build
zrz@Zhao:~/Project/phytium_kernel/phytium-linux-kernel$ export INSTALL_MOD_PATH=`pwd`/build
zrz@Zhao:~/Project/phytium_kernel/phytium-linux-kernel$ make modules_install
zrz@Zhao:~/Project/phytium_kernel/phytium-linux-kernel$ ls build/lib/modules/
5.10.153-phytium-embeded-2023-v1.0-GA
```

其中，模块名称分2 部分：

- 第一部分“5.10.153-rt76-phytium-embeded”不会变化
- 第二部分“-v1.0-GA”会随着版本的不断更新而持续更新，本章节后续章节描述内核模块以不变部分为准。

#### 在编译完成的文件夹中找到如下文件：

- `arch/arm64/boot/Image`
- `arch/arm64/boot/dts/phytium/phytiumpi_firefly.dtb`
- `build/lib/modules/5.10.153-phytium-embeded-2023-v1.0-GA`



### 替换内核：

- 备份并删除原内核，设备树，模块：

  压缩：`tar -czvf archive_name.tar`

  解压：`tar -xvf archive_name.tar`

  ```sh
  user@Phytium-Pi:~/Downloads/temps$ sudo cp /boot/Image ./
  user@Phytium-Pi:~/Downloads/temps$ sudo cp /boot/phytium-pi-board.dtb ./
  user@Phytium-Pi:~/Downloads/temps$ sudo cp /lib/modules/5.10.153-phytium-embeded-2023-V1.0-GA+ ./ -R
  
  user@Phytium-Pi:~/Downloads/temps$ sudo rm -rf /boot/Image
  user@Phytium-Pi:~/Downloads/temps$ sudo rm -rf /boot/phytium-pi-board.dtb
  user@Phytium-Pi:~/Downloads/temps$ sudo rm -rf /lib/modules/5.10.153phytium-embeded-2023-V1.0-GA+
  ```

- 将内核和设备树安装到SD 卡的/boot 目录(注意提前备份旧的内核和设备树以及内核模块)。
  - 将`arch/arm64/boot/Image`复制到SD卡的`/boot`
  - 将`arch/arm64/boot/dts/phytium/phytiumpi_firefly.dtb`复制到SD卡的`/boot`
  
  ```sh
  user@Phytium-P:-/Downloads/config$ sudo cp ./Image /boot/
  user@Phytium-P:-/Downloads/config$ sudo cp ./phytiumpi_firefly.dtb /boot/
  ```
  
- 然后将配套的内核模块安装到/lib/modules：
  - 将`build/lib/modules/5.10.153-rt76-phytium-embeded`复制到SD卡的`/lib/modules`
  - 重命名其为`5.10.153-phytium-embeded-2023-V1.0-GA+`
  
  ```sh
  user@Phytium-P:-/Downloads/config$ sudo cp ./5.10.153-phytium-embeded-2023-V1.0-GA /lib/modules -R
  user@Phytium-P:-/Downloads/config$ sudo mv ./5.10.153-phytium-embeded-2023-V1.0-GA ./5.10.153-phytium-embeded-2023-V1.0-GA+
  ```
  
  

### 串口连接启动新内核

启动开发板，然后在Uboot 启动阶段敲击键盘的回车键，这时系统会停留在Uboot 的Shell 界面，如下所示。

![image-20240111114458786](./%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8.assets/image-20240111114458786.png)

在Uboot 的shell 菜单按照如下步骤引导内核和设备树启动。

- **==设置启动参数，其中，嵌入式Linux 文件系统：==**

  ```bash
  E2000# setenv bootargs 'console=ttyAMA1,115200 earlycon=pl011,0x2800d000 root=/dev/mmcblk0p1 rootwait rw;';
  ```

- **==设置启动命令行，其中，嵌入式Linux 文件系统：==**

  - 加载内核到内存：`ext4load mmc 0:1 0x90100000 boot/Image;`
  
    这时，串口会打印如下信息提示加载成功：

    `28692992 bytes read in 6293 ms (4.3 MiB/s)`

  - 加载设备树到内存：`ext4load mmc 0:1 0x90000000 boot/phytiumpi_firefly.dtb;`
  
    这时，串口会打印如下信息提示加载成功：
  
    `28692992 bytes read in 6293 ms (4.3 MiB/s)`
  
  - 引导启动内核：`booti 0x90100000 – 0x90000000;`
  
  **使用如下命令直接修改bootcmd，方便之后的启动(不需要再手敲一遍上述配置)：**
  
  ```bash
  E2000# setenv bootcmd 'ext4load mmc 0:1 0x90100000 boot/Image; ext4load mmc 0:1 0x90000000 boot/phytiumpi_firefly.dtb; booti 0x90100000 – 0x90000000;';
  ```
  
  这是修改之前的`bootenv`：![修改之前的bootenv](./%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8.assets/image-20240111185310871.png)
  
  这是修改之后的`bootenv`：![修改之后的bootenv](./%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8.assets/image-20240111185035236.png)
  
- **==保存配置：==**

  ```bash
  E2000# saveenv;
  ```

- **reset即可。**

  输出显示如下：

  ```bash
  
  ```




buildroot构建：

./support/kconfig/merge_config.sh configs/phytium_ubuntu_defconfig configs/desktop.config configs/e2000_optee.config



## 2. OS源码内修改内核源码编译

> #### 通过Phytium开发者给出的`<PKG>_OVERRIDE_SRCDIR`机制：
>
> 更改默认OS的内核配置构建整个系统：内核镜像+设备树+文件系统
>
> 参考：https://gitee.com/phytium_embedded/phytium-pi-os里的readme.md文档[README.md](编译内核.assets\README.md) 

### 配置环境变量

由于WSL中PATH包含了windows的PATH，而linux编译时不允许PATH中含有spaces, TABs, and/or newline (\n) characters，所以使用`export`命令手动配置：

> Windows Subsystem for Linux (WSL) 是一种允许在Windows系统上运行Linux发行版的技术。WSL在底层实现中确实会共享某些系统资源，包括环境变量（如PATH）。这可能导致WSL中的Linux发行版的PATH受到Windows系统环境变量的影响。
>
> 主要原因是WSL的设计理念是为了提供与本机系统集成的Linux体验。这使得您可以在WSL中轻松访问Windows文件系统，并且可以在Windows和Linux之间共享一些配置和资源。但正如您提到的，这也可能导致PATH中存在空格等问题，因为Windows系统允许路径中有空格，而Linux则不允许。
>
> 为了解决这个问题，您可以在WSL中适当地调整PATH环境变量，以确保它不包含空格。您可以编辑Linux发行版中的shell配置文件，如`.bashrc`，并将PATH设置为正确的值。在这个文件中，您可以使用`export`命令设置PATH，确保它不包含空格，例如：
>
> ```bash
> export PATH="/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin:/home/user/bin"
> ```
>
> 这样，您可以在WSL中自定义您的PATH，以适应您的需求，而不受Windows环境变量的影响。当然，确保PATH不包含空格是一种好的做法，以避免潜在的问题。

```bash
zrz@Zhao:~/Project/phytium-pi-os$ echo $PATH
/opt/toolchains/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu/bin:/opt/toolchains/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/usr/lib/wsl/lib
```

只截取linux自己的PATH：执行下述命令

```bash
zrz@Zhao:~/Project/phytium-pi-os$ export PATH="/opt/toolchains/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu/bin:/opt/toolchains/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/usr/lib/wsl/lib"
zrz@Zhao:~/Project/phytium-pi-os$ export LC_ALL="zh_CN:zh"
zrz@Zhao:~/Project/phytium-pi-os$ export LC_CTYPE="zh_CN.UTF-8"
zrz@Zhao:~/Project/phytium-pi-os$ export LC_MESSAGES="zh_CN.UTF-8"
```

